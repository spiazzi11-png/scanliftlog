<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Machine Log Demo (QR → Machine Page)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f6f7f8; color:#111; }
    header { padding: 18px 18px 10px; background: #fff; border-bottom: 1px solid #e6e6e6; }
    .wrap { max-width: 860px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .sub { font-size: 13px; color: #444; }
    main { padding: 18px; }
    .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 14px; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } }

    .card { background:#fff; border:1px solid #e6e6e6; border-radius: 14px; padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    label { font-size: 12px; color:#333; }
    input, select, textarea {
      width: 100%;
      padding: 10px 10px;
      border: 1px solid #d8d8d8;
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
    }
    textarea { min-height: 80px; resize: vertical; }

    .btn {
      appearance: none;
      border: 1px solid #0b5;
      background: #0b5;
      color: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn.secondary { border-color:#d8d8d8; background:#fff; color:#111; }
    .btn.danger { border-color:#d33; background:#d33; color:#fff; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }

    .pill { display:inline-flex; padding: 4px 9px; border-radius: 999px; font-size: 12px; border:1px solid #e0e0e0; background:#fafafa; color:#333; }
    .muted { color:#666; font-size: 13px; }
    .kpi { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .kpi .pill strong { margin-left: 6px; }

    .history { margin-top: 10px; }
    .hist-item {
      border: 1px solid #ededed;
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      background:#fcfcfc;
    }
    .hist-top { display:flex; justify-content: space-between; gap: 10px; }
    .hist-date { font-weight: 700; font-size: 13px; }
    .hist-summary { font-size: 13px; color:#333; margin-top: 6px; white-space: pre-wrap; }
    .small { font-size: 12px; color:#666; }

    .setrow { display:grid; grid-template-columns: 1fr 1fr 54px; gap: 10px; align-items:end; }
    .setrow .btn { justify-content:center; padding: 10px 10px; }
    .divider { height:1px; background:#ededed; margin: 12px 0; }

    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 16px;
      background: #111; color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      max-width: calc(100vw - 24px);
      font-size: 13px;
    }
    .toast.show { opacity: 0.92; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Machine Log Demo</h1>
      <div class="sub">
        QR → Machine Page → Log Sets/Reps/Weight → View Your History (no login). Identity is stored on this device via <code>localStorage</code>.
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content: space-between;">
          <div>
            <div class="pill" id="machinePill">Machine</div>
            <div class="pill" id="userPill" title="Anonymous per-device ID">User</div>
          </div>
          <div class="row">
            <button class="btn secondary" id="resetUserBtn" title="Creates a new anonymous user on this device">Reset User</button>
          </div>
        </div>

        <div class="divider"></div>

        <h2 style="margin:0 0 8px; font-size:16px;">Your last workout on this machine</h2>
        <div class="muted" id="lastWorkoutText">None yet. Log your first session below.</div>

        <div class="kpi" id="kpis" style="display:none;">
          <span class="pill">Last Weight <strong id="kpiWeight"></strong></span>
          <span class="pill">Last Volume <strong id="kpiVolume"></strong></span>
          <span class="pill">Workouts Logged <strong id="kpiCount"></strong></span>
        </div>

        <div class="divider"></div>

        <h2 style="margin:0 0 8px; font-size:16px;">Log today’s workout</h2>

        <div id="sets"></div>

        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" id="addSetBtn">+ Add Set</button>
          <button class="btn" id="saveBtn">Save Workout</button>
          <button class="btn danger" id="clearMachineBtn" title="Deletes history for this machine for this user only">Clear This Machine History</button>
        </div>

        <div style="margin-top:10px;">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="e.g., felt strong, slow tempo, drop set on last set"></textarea>
        </div>

        <div class="divider"></div>

        <div class="small">
          Tip: to simulate scanning different machines, add <code>?machine=LEGPR-002</code> or <code>?machine=SHPR-001</code> to the URL.
        </div>
      </section>

      <aside class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">History (this machine)</h2>
        <div class="muted" id="histHint">Your saved sessions appear here for this machine.</div>
        <div class="history" id="history"></div>

        <div class="divider"></div>

        <h2 style="margin:0 0 8px; font-size:16px;">How the “unique user” works</h2>
        <div class="small">
          On first load, the page generates an anonymous ID and stores it on this device:
          <ul>
            <li><code>anon_user_id</code> in <code>localStorage</code></li>
            <li>Every log is saved under <code>(user_id, machine_id)</code></li>
          </ul>
          If you open this page in a different browser/device, it becomes a different “user” unless you later add account signup.
        </div>
      </aside>
    </div>
  </main>

  <div class="toast" id="toast"></div>

<script>
(function(){
  // ---------- Helpers ----------
  function uuidv4() {
    // RFC4122-ish, good enough for demo (use crypto UUID in production)
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1800);
  }

  function getQueryParam(key){
    const params = new URLSearchParams(window.location.search);
    return params.get(key);
  }

  // ---------- Identity ----------
  function getOrCreateUserId(){
    let id = localStorage.getItem('anon_user_id');
    if(!id){
      id = uuidv4();
      localStorage.setItem('anon_user_id', id);
    }
    return id;
  }

  function resetUser(){
    localStorage.removeItem('anon_user_id');
    window.location.reload();
  }

  // ---------- Storage ----------
  function storageKey(userId, machineId){
    return `logs:${userId}:${machineId}`;
  }

  function loadLogs(userId, machineId){
    const raw = localStorage.getItem(storageKey(userId, machineId));
    if(!raw) return [];
    try { return JSON.parse(raw); } catch(e){ return []; }
  }

  function saveLogs(userId, machineId, logs){
    localStorage.setItem(storageKey(userId, machineId), JSON.stringify(logs));
  }

  function clearMachineHistory(userId, machineId){
    localStorage.removeItem(storageKey(userId, machineId));
  }

  // ---------- UI State ----------
  const userId = getOrCreateUserId();
  const machineId = (getQueryParam('machine') || 'SHPR-001').trim();

  const machineNameMap = {
  // Shoulder / Chest
  'SHPR-001': 'Shoulder Press – Machine 1',
  'CHPR-003': 'Chest Press – Machine 1',
  'PECK-001': 'Pec Deck – Machine 1',
  'INCBP-001': 'Incline Bench Press',
  'DECL-001': 'Decline Chest Press – Machine 1',

  // Legs
  'LEGPR-002': 'Leg Press – Machine 2',
  'LEGEXT-001': 'Leg Extension – Machine 1',
  'SQUAT-001': 'Squat Machine – Machine 1',

  // Back
  'LATPD-001': 'Lat Pulldown – Machine 1',
  'BKEXT-001': 'Back Extension – Machine 1',

  // Arms
  'DIP-001': 'Dip Machine – Machine 1',
  'PRCUR-001': 'Preacher Curl Machine – Machine 1',

  // Cable / Free Weight Areas
  'CABLE-001': 'Cable Station – Machine 1',
  'DBRACK-001': 'Dumbbell Rack – Main Floor',

  // Smith Machines
  'SMITH-001': 'Smith Machine – Machine 1',
  'SMITH-002': 'Smith Machine – Machine 2',
  'SMITH-003': 'Smith Machine – Machine 3'
};
  const machineName = machineNameMap[machineId] || `Machine (${machineId})`;

  document.getElementById('machinePill').textContent = machineName;
  document.getElementById('userPill').textContent = `User: ${userId.slice(0,8)}…`;

  document.getElementById('resetUserBtn').addEventListener('click', resetUser);

  // ---------- Sets UI ----------
  const setsDiv = document.getElementById('sets');

  function makeSetRow(setNumber, reps='', weight=''){
    const row = document.createElement('div');
    row.className = 'setrow';
    row.style.marginTop = '10px';

    const repsWrap = document.createElement('div');
    const repsLab = document.createElement('label');
    repsLab.textContent = `Set ${setNumber} – Reps`;
    const repsInp = document.createElement('input');
    repsInp.type = 'number';
    repsInp.min = '0';
    repsInp.placeholder = 'e.g., 10';
    repsInp.value = reps;
    repsWrap.appendChild(repsLab);
    repsWrap.appendChild(repsInp);

    const wtWrap = document.createElement('div');
    const wtLab = document.createElement('label');
    wtLab.textContent = `Set ${setNumber} – Weight (lb)`;
    const wtInp = document.createElement('input');
    wtInp.type = 'number';
    wtInp.min = '0';
    wtInp.step = '0.5';
    wtInp.placeholder = 'e.g., 135';
    wtInp.value = weight;
    wtWrap.appendChild(wtLab);
    wtWrap.appendChild(wtInp);

    const delBtn = document.createElement('button');
    delBtn.className = 'btn secondary';
    delBtn.type = 'button';
    delBtn.textContent = '✕';
    delBtn.title = 'Remove set';
    delBtn.addEventListener('click', () => {
      row.remove();
      renumberSets();
    });

    row.appendChild(repsWrap);
    row.appendChild(wtWrap);
    row.appendChild(delBtn);

    return row;
  }

  function renumberSets(){
    const rows = [...setsDiv.querySelectorAll('.setrow')];
    rows.forEach((row, idx) => {
      const setNum = idx + 1;
      const labels = row.querySelectorAll('label');
      labels[0].textContent = `Set ${setNum} – Reps`;
      labels[1].textContent = `Set ${setNum} – Weight (lb)`;
    });
  }

  function addSet(reps='', weight=''){
    const current = setsDiv.querySelectorAll('.setrow').length;
    setsDiv.appendChild(makeSetRow(current + 1, reps, weight));
  }

  document.getElementById('addSetBtn').addEventListener('click', () => addSet());

  // default sets
  addSet();
  addSet();
  addSet();

  // ---------- History Rendering ----------
  function calcVolume(sets){
    // volume = sum(reps * weight)
    return sets.reduce((sum, s) => sum + (Number(s.reps)||0) * (Number(s.weight)||0), 0);
  }

  function formatSummary(log){
    const lines = log.sets.map((s, i) => `Set ${i+1}: ${s.reps} reps @ ${s.weight} lb`);
    if(log.notes && log.notes.trim()) lines.push(`Notes: ${log.notes.trim()}`);
    return lines.join('\n');
  }

  function render(history){
    const last = history[0];
    const lastText = document.getElementById('lastWorkoutText');
    const kpis = document.getElementById('kpis');

    if(!last){
      lastText.textContent = 'None yet. Log your first session below.';
      kpis.style.display = 'none';
    } else {
      lastText.textContent = `${new Date(last.ts).toLocaleString()} — ${last.sets.length} set(s)`;
      kpis.style.display = 'flex';
      const lastWeight = last.sets.length ? Math.max(...last.sets.map(s => Number(s.weight)||0)) : 0;
      document.getElementById('kpiWeight').textContent = `${lastWeight} lb`;
      document.getElementById('kpiVolume').textContent = `${calcVolume(last.sets).toLocaleString()} lb·reps`;
      document.getElementById('kpiCount').textContent = `${history.length}`;
    }

    const histDiv = document.getElementById('history');
    histDiv.innerHTML = '';
    if(history.length === 0){
      document.getElementById('histHint').textContent = 'Your saved sessions appear here for this machine.';
      return;
    }
    document.getElementById('histHint').textContent = '';

    history.forEach((log, idx) => {
      const item = document.createElement('div');
      item.className = 'hist-item';

      const top = document.createElement('div');
      top.className = 'hist-top';

      const date = document.createElement('div');
      date.className = 'hist-date';
      date.textContent = new Date(log.ts).toLocaleString();

      const actions = document.createElement('div');
      actions.className = 'small';
      actions.innerHTML = `<button class="btn secondary" style="padding:6px 10px; border-radius:10px;" data-idx="${idx}">Load</button>`;

      top.appendChild(date);
      top.appendChild(actions);

      const summary = document.createElement('div');
      summary.className = 'hist-summary';
      summary.textContent = formatSummary(log);

      item.appendChild(top);
      item.appendChild(summary);
      histDiv.appendChild(item);
    });

    // bind load buttons
    histDiv.querySelectorAll('button[data-idx]').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.getAttribute('data-idx'));
        const log = history[idx];
        // load sets into form
        setsDiv.innerHTML = '';
        log.sets.forEach(s => addSet(String(s.reps||''), String(s.weight||'')));
        document.getElementById('notes').value = log.notes || '';
        toast('Loaded workout into editor.');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  }

  function refresh(){
    const history = loadLogs(userId, machineId);
    render(history);
  }

  // ---------- Save ----------
  document.getElementById('saveBtn').addEventListener('click', () => {
    const rows = [...setsDiv.querySelectorAll('.setrow')];
    const sets = rows.map(row => {
      const inputs = row.querySelectorAll('input');
      return { reps: Number(inputs[0].value), weight: Number(inputs[1].value) };
    }).filter(s => (s.reps && s.reps > 0) || (s.weight && s.weight > 0));

    if(sets.length === 0){
      toast('Add at least one set (reps or weight).');
      return;
    }

    const notes = document.getElementById('notes').value || '';
    const history = loadLogs(userId, machineId);

    const log = { ts: Date.now(), sets, notes };
    history.unshift(log);
    saveLogs(userId, machineId, history);

    toast('Workout saved.');
    refresh();
  });

  // ---------- Clear machine ----------
  document.getElementById('clearMachineBtn').addEventListener('click', () => {
    if(!confirm('Delete ALL history for this machine (for this user on this device)?')) return;
    clearMachineHistory(userId, machineId);
    toast('Machine history cleared.');
    refresh();
  });

  // initial render
  refresh();
})();
</script>
</body>
</html>
