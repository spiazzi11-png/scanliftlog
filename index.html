<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ScanLiftLog</title>
  <style>
    :root { --b:#111; --g:#666; --l:#e7e7e7; --bg:#fafafa; --card:#fff; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--b); }
    .wrap { max-width: 900px; margin: 0 auto; padding: 18px; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size: 20px; letter-spacing: .2px; }
    .sub { margin:6px 0 0; color:var(--g); font-size: 13px; }
    .pills { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { font-size:12px; padding:8px 10px; border:1px solid var(--l); background:#fff; border-radius:999px; }
    .card { margin-top:14px; background:var(--card); border:1px solid var(--l); border-radius:14px; padding:14px; }
    label { display:block; font-size: 12px; color:var(--g); margin: 0 0 6px; }
    input { width: 100%; box-sizing:border-box; padding:10px 12px; border:1px solid #ddd; border-radius:12px; font-size:14px; background:#fff; }
    button { padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:800; }
    button.primary { border:0; background:#111; color:#fff; }
    button.danger { border:0; background:#b00020; color:#fff; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width: 220px; }
    .muted { color:var(--g); font-size:12px; }
    .hr { height:1px; background:var(--l); margin:14px 0; }
    .smalllink { border:0; background:transparent; text-decoration:underline; cursor:pointer; font-size:12px; opacity:0.75; padding:0; font-weight:700; }
    .badge { display:inline-block; font-size:11px; padding:4px 8px; border:1px solid var(--l); border-radius:999px; background:#fff; color:var(--g); }

    /* Sets grid */
    .setsHeader { display:grid; grid-template-columns: 52px 1fr 1fr 60px; gap:10px; align-items:center; margin-top:10px; }
    .setRow { display:grid; grid-template-columns: 52px 1fr 1fr 60px; gap:10px; align-items:center; margin-top:10px; }
    .setBadge { display:inline-flex; align-items:center; justify-content:center; width:48px; height:40px; border:1px solid var(--l); border-radius:12px; background:#fff; font-weight:900; }
    .iconBtn { width:44px; height:40px; border-radius:12px; border:1px solid #ddd; display:inline-flex; align-items:center; justify-content:center; font-size:18px; font-weight:900; background:#fff; }
    .iconBtn.primary { background:#111; color:#fff; border:0; }
    .iconBtn.danger { background:#b00020; color:#fff; border:0; }

    /* History */
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid var(--l); font-size: 13px; vertical-align:top; }
    th { color:var(--g); font-weight:900; font-size:12px; }
    details summary { cursor:pointer; font-weight:900; }
    .setsMini { margin-top:8px; width:100%; border-collapse:collapse; }
    .setsMini td, .setsMini th { font-size: 12px; padding:6px 6px; border-bottom:1px solid var(--l); }
    footer { margin:16px 0 6px; text-align:center; color:var(--g); font-size:12px; }
    footer a { color:inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>ScanLiftLog</h1>
        <div class="sub">Scan a machine QR code to view and log your workout history.</div>
      </div>

      <div class="pills">
        <div class="pill" id="machinePill">Loading…</div>
        <div class="pill" id="userPill">User: …</div>
        <div class="pill"><button class="smalllink" id="resetUserBtn" type="button">Reset User ID</button></div>
      </div>
    </div>

    <!-- Logger -->
    <div class="row" style="align-items:flex-end; margin-top:12px;">
  <div class="col">
    <label>Exercise (optional)</label>
    <input id="exerciseInput" placeholder="e.g., Dumbbell Flys, DB Press, Incline DB Row" />
  </div>
</div>
    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div class="col">
          <label>Date</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="col">
          <label>Notes (optional)</label>
          <input id="notesInput" placeholder="e.g., controlled reps, last set to failure" />
        </div>
      </div>

      <div class="hr"></div>

      <div style="font-weight:900;">Sets</div>
      <div class="muted" style="margin-top:6px;">Use + to add sets. Each set stores weight and reps.</div>

      <div class="setsHeader">
        <div class="muted">Set</div>
        <div class="muted">Weight</div>
        <div class="muted">Reps</div>
        <div class="muted">Del</div>
      </div>

      <div id="setsContainer"></div>

      <div class="btnrow" style="margin-top:12px;">
        <button class="iconBtn primary" id="addSetBtn" type="button">+</button>
        <div class="muted">Add set</div>
      </div>

      <div class="btnrow" style="margin-top:14px;">
        <button class="primary" id="saveWorkoutBtn" type="button">Save Workout</button>
        <button id="clearCurrentBtn" type="button">Clear Current Sets</button>
        <button class="danger" id="clearHistoryBtn" type="button">Clear All History (this machine)</button>
      </div>
    </div>

    <!-- History -->
    <div class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div style="font-weight:900;">History</div>
        <div class="badge" id="historyScopeBadge">Scope: …</div>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:110px;">Date</th>
              <th style="min-width:70px;">Sets</th>
              <th style="min-width:120px;">Top Set</th>
              <th>Details</th>
              <th style="min-width:140px;">Saved</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="5" class="muted">No workouts saved yet.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px;">
        Example QR link format:
        <span class="badge">?machine=SHPR</span>
      </div>
    </div>

    <footer>
      © <span id="year"></span> ScanLiftLog •
      <a href="https://spiazzi11-png.github.io/scanliftlog/" target="_blank" rel="noopener">Home</a>
    </footer>
  </div>

<script>
/* ---------- Utilities ---------- */
function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function nowReadable() {
  return new Date().toLocaleString();
}
function safeJSONParse(s, fallback) {
  try { return JSON.parse(s); } catch { return fallback; }
}
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ---------- User ID (device-local) ---------- */
const USER_KEY = 'scanliftlog_user_v1';
function getOrCreateUserId() {
  let id = localStorage.getItem(USER_KEY);
  if (!id) {
    id = 'u_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
    localStorage.setItem(USER_KEY, id);
  }
  return id;
}
function resetUser() {
  localStorage.removeItem(USER_KEY);
  location.reload();
}

/* ---------- UI State ---------- */
const exerciseInput = document.getElementById('exerciseInput');
const userId = getOrCreateUserId();
const machineParam = getQueryParam('machine');
const machineId = machineParam ? machineParam.trim().toUpperCase() : null;

/* ---------- Full Machine Map ---------- */
const MACHINE_MAP = {
  // Chest
  "CHPR": "Flat Chest Press",
  "INCHPR": "Incline Chest Press",
  "DECHPR": "Decline Chest Press",
  "PECDK": "Pec Deck / Chest Fly",
  "CABFLY": "Cable Fly (Chest)",
  "SMTH": "Smith Machine",

  // Shoulders
  "SHPR": "Shoulder Press",
  "LATRL": "Lateral Raise",
  "RDLT": "Rear Delt Fly",
  "UPROW": "Upright Row",

  // Back
  "LATPD": "Lat Pulldown",
  "SETRW": "Seated Row",
  "HIRW": "High Row",
  "ASSTPD": "Assisted Pull-Up / Dip",
  "STRPD": "Straight-Arm Pulldown",
  "BKEXT": "Back Extension",

  // Legs
  "LEGPR": "Leg Press",
  "HKSQ": "Hack Squat",
  "SQMT": "Squat Machine",
  "LEGEX": "Leg Extension",
  "SLCUR": "Seated Leg Curl",
  "LLCUR": "Lying Leg Curl",
  "STCUR": "Standing Leg Curl",
  "HIPAB": "Hip Abductor",
  "HIPAD": "Hip Adductor",
  "GLUTKB": "Glute Kickback",
  "SCALF": "Seated Calf Raise",
  "STCALF": "Standing Calf Raise",

  // Arms
  "PRCUR": "Preacher Curl",
  "BICUR": "Biceps Curl",
  "CABCRL": "Cable Curl",
  "TRIEX": "Triceps Extension",
  "DIPMT": "Dip Machine",
  "CABPD": "Cable Pushdown",

  // Core
  "ABCR": "Ab Crunch",
  "RTTOR": "Rotary Torso",
  "CAPCH": "Captain’s Chair",
  "DABEN": "Decline Ab Bench",
  "CABAB": "Cable Crunch",

  // Free weights
  "FBEN": "Flat Bench",
  "IBEN": "Incline Bench",
  "DBEN": "Decline Bench",
  "SQRK": "Squat Rack",
  "PWRK": "Power Rack",
  "DBRCK": "Dumbbell Rack",

  // Cardio (optional)
  "TRED": "Treadmill",
  "ELIP": "Elliptical",
  "STAIR": "Stair Climber",
  "BIKE": "Stationary Bike",
  "ROW": "Rower"
};

const machineName = machineId
  ? (MACHINE_MAP[machineId] || `Machine (${machineId})`)
  : "Scan a machine QR code to begin";


/* Storage: workouts per user+machine */
function storageKeyFor(mid) {
  return `scanliftlog_workouts_v1:${userId}:${mid}`;
}
function loadWorkouts() {
  if (!machineId) return [];
  return safeJSONParse(localStorage.getItem(storageKeyFor(machineId)) || "[]", []);
}
}
function saveWorkouts(arr) {
  if (!machineId) return;
  localStorage.setItem(storageKeyFor(machineId), JSON.stringify(arr));
}

/* ---------- UI Elements ---------- */
const setsContainer = document.getElementById('setsContainer');
const dateInput = document.getElementById('dateInput');
const notesInput = document.getElementById('notesInput');
const exerciseInput = document.getElementById('exerciseInput');

/* ---------- Sets UI ---------- */
function createSetRow(setIndex, weight="", reps="") {
  const row = document.createElement('div');
  row.className = 'setRow';
  row.dataset.index = String(setIndex);

  const badge = document.createElement('div');
  badge.className = 'setBadge';
  badge.textContent = String(setIndex + 1);

  const w = document.createElement('input');
  w.placeholder = 'e.g., 180';
  w.inputMode = 'decimal';
  w.value = weight;

  const r = document.createElement('input');
  r.placeholder = 'e.g., 10';
  r.inputMode = 'numeric';
  r.value = reps;

  const del = document.createElement('button');
  del.className = 'iconBtn danger';
  del.type = 'button';
  del.textContent = '−';
  del.title = 'Remove set';
  del.onclick = () => {
    row.remove();
    renumberSets();
  };

  row.appendChild(badge);
  row.appendChild(w);
  row.appendChild(r);
  row.appendChild(del);
  return row;
}

function renumberSets() {
  const rows = Array.from(setsContainer.querySelectorAll('.setRow'));
  rows.forEach((row, i) => {
    row.dataset.index = String(i);
    row.querySelector('.setBadge').textContent = String(i + 1);
  });
}

function addSet(weight="", reps="") {
  const idx = setsContainer.querySelectorAll('.setRow').length;
  setsContainer.appendChild(createSetRow(idx, weight, reps));
}

function clearCurrentSets() {
  setsContainer.innerHTML = "";
  addSet("", "");
}

/* ---------- Save / History ---------- */
if (!machineId) {
  alert("Scan a machine QR code before saving a workout.");
  return;
}  
  
  function readCurrentSets() {
  const rows = Array.from(setsContainer.querySelectorAll('.setRow'));
  const sets = rows.map(row => {
    const inputs = row.querySelectorAll('input');
    return {
      weight: (inputs[0].value || "").trim(),
      reps: (inputs[1].value || "").trim()
    };
  }).filter(s => s.weight || s.reps);
  return sets;
}

function getTopSet(sets) {
  let best = null;
  let bestW = -Infinity;
  for (const s of sets) {
    const w = parseFloat(String(s.weight).replace(/[^0-9.]/g,''));
    if (!Number.isNaN(w) && w > bestW) { bestW = w; best = s; }
  }
  return best || sets[0] || null;
}

function renderHistory() {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = "";

  const workouts = loadWorkouts();
  if (!workouts.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="muted">No workouts saved yet.</td></tr>`;
    return;
  }

  const sorted = workouts.slice().sort((a,b) => (b.ts||0) - (a.ts||0));
  for (const w of sorted) {
    const top = getTopSet(w.sets || []);
    const topText = top ? `${escapeHtml(top.weight || "—")} x ${escapeHtml(top.reps || "—")}` : "—";

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(w.date || "")}</td>
      <td>${(w.sets||[]).length}</td>
      <td>${topText}</td>
      <td>
        <details>
          <summary>View sets</summary>
          ${w.notes ? `<div class="muted" style="margin-top:6px;">Notes: ${escapeHtml(w.notes)}</div>` : ""}
          <table class="setsMini">
            <thead><tr><th>Set</th><th>Weight</th><th>Reps</th></tr></thead>
            <tbody>
              ${(w.sets||[]).map((s,i)=>`
                <tr><td>${i+1}</td><td>${escapeHtml(s.weight||"")}</td><td>${escapeHtml(s.reps||"")}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </details>
      </td>
      <td class="muted">${escapeHtml(w.savedAt || "")}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ---------- Wire up ---------- */
document.getElementById('year').textContent = String(new Date().getFullYear());
document.getElementById('machinePill').textContent = machineName;
document.getElementById('userPill').textContent = `User: ${userId.slice(0,8)}…`;
document.getElementById('historyScopeBadge').textContent = `Scope: ${machineId || "—"}`;
document.getElementById('resetUserBtn').addEventListener('click', resetUser);

dateInput.value = todayISO();

document.getElementById('addSetBtn').addEventListener('click', () => addSet("", ""));
document.getElementById('clearCurrentBtn').addEventListener('click', clearCurrentSets);

document.getElementById('saveWorkoutBtn').addEventListener('click', () => {
  if (!machineId) {
    alert("Scan a machine QR code before saving a workout.");
    return;
  }

  const date = (dateInput.value || todayISO()).trim();
  const notes = (notesInput.value || "").trim();
  const exercise = (exerciseInput.value || "").trim();
  const sets = readCurrentSets();

  if (!sets.length) {
    alert("Add at least one set (weight and/or reps) before saving.");
    return;
  }

  const workouts = loadWorkouts();
  workouts.push({
    ts: Date.now(),
    date,
    exercise,
    notes,
    sets,
    savedAt: nowReadable()
  });
  saveWorkouts(workouts);

  exerciseInput.value = "";
  notesInput.value = "";
  clearCurrentSets();
  renderHistory();
});

document.getElementById('clearHistoryBtn').addEventListener('click', () => {
  if (!confirm("Clear ALL history for this machine on this device?")) return;
  saveWorkouts([]);
  renderHistory();
});

/* Init */
clearCurrentSets();
renderHistory();
</script>
</body>
</html>
